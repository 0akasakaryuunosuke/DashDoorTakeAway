{"version":3,"sources":["uni-app:///main.js","webpack:///D:/VMware/koala/code/uniapp/pages/login/login.vue?4518","webpack:///D:/VMware/koala/code/uniapp/pages/login/login.vue?0610","webpack:///D:/VMware/koala/code/uniapp/pages/login/login.vue?6f89","webpack:///D:/VMware/koala/code/uniapp/pages/login/login.vue?b203","uni-app:///pages/login/login.vue"],"names":["wx","__webpack_require_UNI_MP_PLUGIN__","__webpack_require__","createPage","Page","renderjs","component","options","__file","components","uniForms","uniFormsItem","uniEasyinput","e","message","indexOf","console","error","render","_vm","this","_h","$createElement","_self","_c","recyclableRender","staticRenderFns","_withStripped","data","form","username","password","role","rules","required","errorMessage","minLength","maxLength","loginCode","methods","bindblur","onChooseAvatar","saveFileLocally","url","success","fs","tempFilePath","filePath","uni","title","duration","fail","icon","handleSavedFile","login","handleLogin","handleGetUserProfile","content","getUserProfile","desc","name","code","avatarUrl","nickName"],"mappings":"2IAAA,MAGA,aACA,WAFAA,EAAGC,kCAAoCC,EAGvCC,EAAWC,a,+ECLX,2HACIC,EADJ,QAQIC,EAAY,qBACd,aACA,YACA,sBACA,EACA,KACA,KACA,MACA,EACA,gBACAD,GAGFC,EAAUC,QAAQC,OAAS,wBACZ,aAAAF,E,yCCtBf,sQ,gCCAA,IAAIG,EAAJ,0LACA,IACEA,EAAa,CACXC,SAAU,WACR,OAAO,wHAITC,aAAc,WACZ,OAAO,kIAITC,aAAc,WACZ,OAAO,iGAKX,MAAOC,GACP,IAC+C,IAA7CA,EAAEC,QAAQC,QAAQ,wBACa,IAA/BF,EAAEC,QAAQC,QAAQ,QAWlB,MAAMF,EATNG,QAAQC,MAAMJ,EAAEC,SAChBE,QAAQC,MAAM,mBACdD,QAAQC,MACN,uFAEFD,QAAQC,MACN,mDAMN,IAAIC,EAAS,WACX,IAAIC,EAAMC,KACNC,EAAKF,EAAIG,eACJH,EAAII,MAAMC,IAEjBC,GAAmB,EACnBC,EAAkB,GACtBR,EAAOS,eAAgB,G,gCC3CvB,wHAAyqB,eAAG,G,4HC2B5qB,eACA,CACAC,gBACA,OACAC,MACAC,YACAC,YACAC,aAEAC,OACAH,UACAG,OACA,CAAAC,YAAAC,sBACA,CAAAC,YAAAC,aAAAF,sDAGAJ,UACAE,OACA,CAAAC,YAAAC,sBACA,CAAAC,YAAAC,aAAAF,uDAIAG,eAGAC,SACAC,qBACA,8BAGAC,2BACA,eACA,yBACA,oCAGAC,4BAAA,WAEA,EASA1C,gBACA2C,MACAC,oBACA,qBACA,MASA,+BACA,gEAGAC,YACAC,eACAC,WACAH,oBACA5B,uCAEAgC,aACAC,eACAC,eAIA,oCAEAC,iBACAnC,2BAEAgC,aACAC,iBACAG,uBA/BAJ,aACAC,eACAG,gBAkCAD,iBACAnC,2BAEAgC,aACAC,iBACAG,kBAtDAJ,aACAC,eACAG,gBA2DAC,4BAEArD,0BACA+C,WACAH,mBACAI,aACAC,eACAC,gBAGAC,iBACAnC,4BAEAgC,aACAC,gBACAG,mBAQAE,iBAAA,WACAtC,uBACA,6CACA,mDACA,gBACAgC,aACAI,eACAH,eAEAD,mCAGAA,aACAL,4BAGAK,aACAI,aACAH,oBAIA,mBACAjC,6BAKAuC,uBAAA,WAEAvD,SACA4C,oBACA,QACA5B,mCACA,mBACA,0BAEAA,mCAGAmC,iBACAnC,mCAMAwC,gCAAA,WACAR,aACAC,aACAQ,oCACAb,oBACA,UAEA,mBAGA5B,0BAKA0C,0BAAA,WACA1D,kBACA2D,gBACAf,oBACA,iBACA,cACA,aAEA5C,gBACA2C,MACAC,oBACA,uBAEA,qBAGA5C,cACA2C,mCACAI,WACAa,YACAhB,oBACA,aACA5B,yBAGA,6BACA6C,iBACAC,gBACAC,aACA,kBACA,gBACAf,aACAI,eACAH,iBAEAD,mCAEAA,aACAL,4BAGAK,aACAI,aACAH,6BAGA,mBACAD,aACAI,aACAH,8BAEAjC,+BAGAmC,iBACAnC,2BACAgC,aACAI,aACAH,sBAMAE,iBACAnC,2BACAgC,aACAI,aACAH,qBAKAE,iBACAnC,6BACAgC,aACAI,aACAH,yBAQA,c","file":"pages/login/login.js","sourcesContent":["import 'uni-pages';\n// @ts-ignore\nwx.__webpack_require_UNI_MP_PLUGIN__ = __webpack_require__;\nimport Vue from 'vue'\nimport Page from './pages/login/login.vue'\ncreatePage(Page)","import { render, staticRenderFns, recyclableRender, components } from \"./login.vue?vue&type=template&id=b237504c&\"\nvar renderjs\nimport script from \"./login.vue?vue&type=script&lang=js&\"\nexport * from \"./login.vue?vue&type=script&lang=js&\"\n\n\n/* normalize component */\nimport normalizer from \"!../../../../../../IDEA/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/runtime/componentNormalizer.js\"\nvar component = normalizer(\n  script,\n  render,\n  staticRenderFns,\n  false,\n  null,\n  null,\n  null,\n  false,\n  components,\n  renderjs\n)\n\ncomponent.options.__file = \"pages/login/login.vue\"\nexport default component.exports","export * from \"-!../../../../../../IDEA/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/loaders/templateLoader.js??vue-loader-options!../../../../../../IDEA/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--17-0!../../../../../../IDEA/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/template.js!../../../../../../IDEA/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-uni-app-loader/page-meta.js!../../../../../../IDEA/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../../../IDEA/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./login.vue?vue&type=template&id=b237504c&\"","var components\ntry {\n  components = {\n    uniForms: function () {\n      return import(\n        /* webpackChunkName: \"uni_modules/uni-forms/components/uni-forms/uni-forms\" */ \"@/uni_modules/uni-forms/components/uni-forms/uni-forms.vue\"\n      )\n    },\n    uniFormsItem: function () {\n      return import(\n        /* webpackChunkName: \"uni_modules/uni-forms/components/uni-forms-item/uni-forms-item\" */ \"@/uni_modules/uni-forms/components/uni-forms-item/uni-forms-item.vue\"\n      )\n    },\n    uniEasyinput: function () {\n      return import(\n        /* webpackChunkName: \"uni_modules/uni-easyinput/components/uni-easyinput/uni-easyinput\" */ \"@/uni_modules/uni-easyinput/components/uni-easyinput/uni-easyinput.vue\"\n      )\n    },\n  }\n} catch (e) {\n  if (\n    e.message.indexOf(\"Cannot find module\") !== -1 &&\n    e.message.indexOf(\".vue\") !== -1\n  ) {\n    console.error(e.message)\n    console.error(\"1. 排查组件名称拼写是否正确\")\n    console.error(\n      \"2. 排查组件是否符合 easycom 规范，文档：https://uniapp.dcloud.net.cn/collocation/pages?id=easycom\"\n    )\n    console.error(\n      \"3. 若组件不符合 easycom 规范，需手动引入，并在 components 中注册该组件\"\n    )\n  } else {\n    throw e\n  }\n}\nvar render = function () {\n  var _vm = this\n  var _h = _vm.$createElement\n  var _c = _vm._self._c || _h\n}\nvar recyclableRender = false\nvar staticRenderFns = []\nrender._withStripped = true\n\nexport { render, staticRenderFns, recyclableRender, components }","import mod from \"-!../../../../../../IDEA/HBuilderX/plugins/uniapp-cli/node_modules/babel-loader/lib/index.js!../../../../../../IDEA/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--13-1!../../../../../../IDEA/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/script.js!../../../../../../IDEA/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../../../IDEA/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./login.vue?vue&type=script&lang=js&\"; export default mod; export * from \"-!../../../../../../IDEA/HBuilderX/plugins/uniapp-cli/node_modules/babel-loader/lib/index.js!../../../../../../IDEA/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--13-1!../../../../../../IDEA/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/script.js!../../../../../../IDEA/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../../../IDEA/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./login.vue?vue&type=script&lang=js&\"","<template>\n    <view style=\"padding: 40rpx;\">\n        <view style=\"padding: 20rpx; margin: 80rpx 0; background-color: #fff; box-shadow: 0 2rpx 10rpx rgba(0,0,0,.1); border-radius: 10rpx;\">\n            <view style=\"margin: 50rpx 30rpx; font-size: 40rpx;\">欢迎登录</view>\n            <uni-forms ref=\"form\" :modelValue=\"form\" :rules=\"rules\" validateTrigger='blur'>\n                <uni-forms-item name=\"username\" required>\n                    <uni-easyinput prefixIcon=\"person\" v-model=\"form.username\" placeholder=\"请输入账号\" />\n                </uni-forms-item>\n                <uni-forms-item name=\"password\" required>\n                    <uni-easyinput type=\"password\" prefixIcon=\"locked\" v-model=\"form.password\" placeholder=\"请输入密码\" />\n                </uni-forms-item>\n                <uni-forms-item>\n                    <button @click=\"login()\" style=\"background-color: #ffd100; border-color: #ffd100; height: 70rpx; line-height: 70rpx;\">登 录</button>\n                </uni-forms-item>\n                <uni-forms-item>\n                    <view style=\"text-align: right;\">还没有账号？去 <navigator style=\"display: inline-block; color: dodgerblue; \n                        margin-left: 4rpx;\" url=\"/pages/register/register\">注册</navigator></view>\t\n                </uni-forms-item>\n            </uni-forms>\n            <view style=\"margin-top: 30rpx; text-align: center;\">\n                <button @click=\"handleLogin\" style=\"background-color: #07c160; color: #fff; border: none; height: 70rpx; line-height: 70rpx;\">微信一键登录</button>\r\n\t\t\t</view>\n        </view>\n    </view>\n</template>\n\n<script>\r\nimport OSS from 'ali-oss'; // 引入阿里云OSS SDK\nexport default {\n    data() {\n        return {\n            form: {\n                username: '',\n                password: '',\n                role: 'USER'\n            },\n            rules: {\n                username: {\n                    rules: [\n                        { required: true, errorMessage: '请输入账号' },\n                        { minLength: 3, maxLength: 10, errorMessage: '账号长度在 {minLength} 到 {maxLength} 个字符' }\n                    ],\n                },\n                password: {\n                    rules: [\n                        { required: true, errorMessage: '请输入密码' },\n                        { minLength: 3, maxLength: 10, errorMessage: '密码长度在 {minLength} 到 {maxLength} 个字符' }\n                    ],\n                }\n            },\n            loginCode: ''\n        };\n    },\n    methods: {\r\nbindblur(event) {\n\t\t\t\tthis.nameUser = event.target.value;\n\n},\r\n    onChooseAvatar(res) {\n        const { detail } = res;\n        this.imagUrl = detail.avatarUrl; // 临时头像路径\n        this.saveFileLocally(this.imagUrl); // 保存头像\n    },\n\nsaveFileLocally(filePath) {\n    // 检查输入的文件路径是否有效\n    if (!filePath) {\n        uni.showToast({\n            title: '文件路径无效',\n            icon: 'error'\n        });\n        return;\n    }\n\n    // 下载微信头像临时 URL\n    wx.downloadFile({\n        url: filePath, // 微信头像的临时 URL\n        success: (res) => {\n            const tempFilePath = res.tempFilePath; // 临时文件路径\n            if (!tempFilePath) {\n                uni.showToast({\n                    title: '文件下载失败',\n                    icon: 'error'\n                });\n                return;\n            }\n\n            // 使用文件系统管理器将文件保存到本地\n            const fs = wx.getFileSystemManager();\n            const localFilePath = `${wx.env.USER_DATA_PATH}/${Date.now()}.jpg`; // 本地文件路径\n\n            // 保存文件到本地\n            fs.saveFile({\n                tempFilePath: tempFilePath, // 临时文件路径\n                filePath: localFilePath, // 本地永久文件路径\n                success: (saveRes) => {\n                    console.log('文件保存成功：', saveRes.savedFilePath);\n\n                    uni.showToast({\n                        title: '文件保存成功',\n                        duration: 2000\n                    });\n\n                    // 提供后续操作的灵活性，例如：读取文件或保存到相册\n                    this.handleSavedFile(saveRes.savedFilePath);\n                },\n                fail: (saveErr) => {\n                    console.error('保存文件失败：', saveErr);\n\n                    uni.showToast({\n                        title: '保存失败，请重试',\n                        icon: 'error'\n                    });\n                }\n            });\n        },\n        fail: (err) => {\n            console.error('文件下载失败：', err);\n\n            uni.showToast({\n                title: '下载失败，请重试',\n                icon: 'error'\n            });\n        }\n    });\n},\n\n// 处理保存后的文件（例如显示或存入相册）\nhandleSavedFile(filePath) {\n    // 可选：将文件保存到相册\n    wx.saveImageToPhotosAlbum({\n        filePath: filePath,\n        success: () => {\n            uni.showToast({\n                title: '已保存到相册',\n                duration: 2000\n            });\n        },\n        fail: (err) => {\n            console.error('保存到相册失败：', err);\n\n            uni.showToast({\n                title: '保存到相册失败',\n                icon: 'error'\n            });\n        }\n    });\n},\n\r\n\n        // 普通登录方法\n        login() {\n            console.log('页面加载成功！'); // 确保这里能输出日志\n            this.$refs.form.validate().then(res => {\n                this.$request.post('/login', this.form).then(res => {\n                    if (res.code === '200') {\n                        uni.showToast({\n                            icon: 'success',\n                            title: '登录成功'\n                        });\n                        uni.setStorageSync('xm-user', res.data);\n\n                        // 跳转主页\n                        uni.switchTab({\n                            url: '/pages/index/index'\n                        });\n                    } else {\n                        uni.showToast({\n                            icon: 'error',\n                            title: res.msg\n                        });\n                    }\n                });\n            }).catch(err => {\n                console.log('表单错误信息：', err);\n            });\n        },\n\n        // 微信登录方法\n        handleLogin() {\r\n\t\t\t\n            wx.login({\n                success: (loginRes) => {\n                    if (loginRes.code) {\n                        console.log('微信登录成功，code:', loginRes.code);\n                        this.loginCode = loginRes.code;\n                        this.handleGetUserProfile(); // 弹窗授权\n                    } else {\n                        console.error('微信登录失败：', loginRes.errMsg);\n                    }\n                },\n                fail: (err) => {\n                    console.error('微信登录接口调用失败：', err);\n                }\n            });\n        },\n\n        // 弹窗授权\n        handleGetUserProfile() {\n            uni.showModal({\n                title: '用户授权',\n                content: '我们需要获取您的昵称和头像信息来完善您的个人资料。',\n                success: (res) => {\n                    if (res.confirm) {\n                        // 用户点击授权\n                        this.getUserProfile();\n                    } else {\n                        // 用户点击取消\n                        console.log('用户取消授权');\n                    }\n                }\n            });\n        },\r\ngetUserProfile() {\n    wx.getUserProfile({\n        desc: '用于完善用户信息', // 提示信息，必须提供\n        success: (profileRes) => {\n            const userInfo = profileRes.userInfo;\n            const avatarUrl = userInfo.avatarUrl; // 用户头像 URL（临时）\n       const nickName = userInfo.nickName;  // 用户昵称\n            // 下载头像到本地\n            wx.downloadFile({\n                url: avatarUrl,\n                success: (downloadRes) => {\n                    if (downloadRes.statusCode === 200) {\n                        // 本地临时文件路径\n                        const tempFilePath = downloadRes.tempFilePath;\n\n                        // 上传头像文件到后端\n                        wx.uploadFile({\n                            url: 'http://localhost:9090/upload', // 替换为后端上传接口地址\n                            filePath: tempFilePath,\n                            name: 'file', // 表单文件字段名\n                            success: (uploadRes) => {\n                                const data = uploadRes.data;\n                                console.log('头像上传成功:', data);\n\n                                // 将头像 URL 存入后端用户信息\n                                this.$request.post('/wx-login', {\n                                    code: this.loginCode, // 从 handleLogin 获取的 code\n                                    avatarUrl: data.url ,// 返回的头像 URL\r\n\t\t\t\t\t\t\t\t\t      nickName: nickName    // 用户昵称\n                                }).then(response => {\n                                    if (response.code === '200') {\n                                        uni.showToast({\n                                            icon: 'success',\n                                            title: '微信登录成功'\n                                        });\n                                        uni.setStorageSync('xm-user', response.data);\n                                        // 跳转主页\n                                        uni.switchTab({\n                                            url: '/pages/index/index'\n                                        });\n                                    } else {\n                                        uni.showToast({\n                                            icon: 'error',\n                                            title: response.msg || '登录失败，请重试'\n                                        });\n                                    }\n                                }).catch(error => {\n                                    uni.showToast({\n                                        icon: 'error',\n                                        title: error.message || '登录失败，请重试'\n                                    });\n                                    console.error('微信登录失败:', error);\n                                });\n                            },\n                            fail: (err) => {\n                                console.error('头像上传失败:', err);\n                                uni.showToast({\n                                    icon: 'error',\n                                    title: '头像上传失败'\n                                });\n                            }\n                        });\n                    }\n                },\n                fail: (err) => {\n                    console.error('头像下载失败:', err);\n                    uni.showToast({\n                        icon: 'error',\n                        title: '头像下载失败'\n                    });\n                }\n            });\n        },\n        fail: (err) => {\n            console.error('获取用户信息失败：', err);\n            uni.showToast({\n                icon: 'error',\n                title: '获取用户信息失败'\n            });\n        }\n    });\n}\n\n\n    }\n};\n</script>\n\n<style>\n</style>\n"],"sourceRoot":""}